#!/bin/bash

INPUT_DIR="pokemon_data"
OUTPUT_CSV="pokemon_report.csv"

# Check if the input directory exists
if [ ! -d "${INPUT_DIR}" ]; then
  echo "Error: Directory '${INPUT_DIR}' not found. Please run Task 2 first."
  exit 1
fi

# Write CSV header
echo "Name,Height (m),Weight (kg)" > "${OUTPUT_CSV}"

# Process each JSON file
for file_path in "${INPUT_DIR}"/*.json; do
  if [ -f "${file_path}" ]; then
    # Use jq to extract data and format as CSV, appending to the output file
    jq -r '[.name, (.height / 10), (.weight / 10)] | @csv' "${file_path}" >> "${OUTPUT_CSV}"
  fi
done

# Capitalize the first letter of each PokÃ©mon's name in the CSV using awk
awk -F, 'BEGIN {OFS=FS} NR > 1 {gsub(/"/, "", $1); $1 = toupper(substr($1,1,1)) substr($1,2); $1 = "\"" $1 "\""} 1' "${OUTPUT_CSV}" > temp.csv && mv temp.csv "${OUTPUT_CSV}"

echo "CSV Report generated at: ${OUTPUT_CSV}"
echo ""

# Display the CSV report
cat "${OUTPUT_CSV}"
echo ""

# awk script to calculate averages
read -r -d '' AWK_SCRIPT << 'EOF'
NR > 1 {
    gsub(/"/, "", $2);
    gsub(/"/, "", $3);
    sum_height += $2;
    sum_weight += $3;
    count++;
}
END {
    if (count > 0) {
        printf "Average Height: %.2f m\n", sum_height / count;
        printf "Average Weight: %.2f kg\n", sum_weight / count;
    }
}
EOF

# Calculate and display average height and weight using awk
awk -F, "$AWK_SCRIPT" "${OUTPUT_CSV}"
